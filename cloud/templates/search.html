{% extends 'main_template.html' %}
{% load static %}

{% block title %}
    Cloud Поиск
{% endblock %}

{% block search_active %}
    class="active"
{% endblock %}

{% block head %}
    <!-- Showdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.8.6/showdown.min.js"
            integrity="sha256-dwhppIrxD8qC6lNulndZgtIm4XBU9zoMd9OUoXzIDAE=" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}


    <div class="search-panel row">


        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 search-select">{{ university.university }}</div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 search-select">{{ department.department }}</div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 search-select">{{ chair.chair }}</div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 search-select">{{ program.program }}</div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4 search-select">{{ subject.subject }}</div>

        <hr>
        <div id="search-line" class="col-xs-12 col-sm-7 col-md-9 col-lg-9">
            <input class="form-control" type="text" placeholder="Введите запрос">
        </div>
        <div id="search-type" class="col-xs-12 col-sm-3 col-md-2 col-lg-2">
            {{ subject.type }}
        </div>
        <div id="search-button" class="col-xs-12 col-sm-2 col-md-1 col-lg-1">
            <input class="form-control btn btn-primary" type="submit" onclick="search_posts()" value="Поиск">
        </div>

    </div>

    <div class="post-list">
        <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3"></div>
        <div id="search_results" class="col-xs-12 col-sm-12 col-md-6 col-lg-6 no-margin-padding">

            <div class='search-post-panel' style='padding: 10px;'>
                Здесь будут отображаться результаты поиска. <br>
                Введите ваш запрос
            </div>


        </div>
        <div class="col-xs-12 col-sm-12 col-md-3 col-lg-3"></div>
    </div>


{% endblock %}


{% block js %}

    <script src="{% static "js/department_search.js" %}"></script>
    <script src="{% static 'js/toMarkdown.js' %}"></script>

    <script>

        $(document).ready(function () {
            clear_and_disabled_all_elements();
            get_all_universities();
            $("#id_university").change(function () {
                university_updated($(this).val())
            });
            $("#id_department").change(function () {
                department_updated($(this).val())
            });
            $("#id_chair").change(function () {
                chair_updated($(this).val())
            });
            $("#id_program").change(function () {
                program_updated($(this).val())
            });

            $("#id_type option:first").text("Любой");
        });

        function post_to_html(item) {
            date = new Date(item.created_date)
                .toLocaleString("ru", {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric'
                });

            let image, file;
            if (item.image !== "")
                image = " <img src=" + item.image + " class='post-img'>";
            else
                image = "";
            if (item.file !== "")
                file = "<a href='" + item.file + "'> <div class='btn btn-success full-width'>Прикепленный файл</div></a>";
            else
                file = "";

            return "<div class='search-post-panel'> " +
                "<a target='_blank' href='/post/" + item.id + "/'><h4>" + item.title + "</h4> </a>" +
                "<div class='post-text'><p>" + item.text + "</p></div>" +
                image +
                file +
                "<table class='table'> <tr>" +
                "<td>" + item.author_username + "</td>" +
                "<td><a href='/subject/" + item.subject_id + "'>" + item.subject_short_title + "</td>" +
                "<td>" + item.type_title + "</td>" +
                "<td>" + date + "</td>" +
                "<td> <span style='font-size:12px;' class='showopacity glyphicon glyphicon-eye-open'></span>" + item.views + "</td> " +
                "</tr></table>" +
                "</div>"
        }

        function update_post_list(posts) {
            $("#search_results").empty();
            if (posts.length !== 0) {
                posts.forEach(function (item, i, arr) {
                    $('#search_results').append(post_to_html(item));
                });
                update_markdown();
            } else {
                $('#search_results').append("<div class='search-post-panel' style='padding: 10px;'>К сожалению, по вашему запросу ничего не найдено :(</div>");
            }
        }

        function get_current_values() {
            let university_id;
            let department_id;
            let chair_id;
            let program_id;
            let subject_id;
            let type_id;
            if ($("#id_university").prop('disabled') === false)
                university_id = $("#id_university").val();
            if ($("#id_department").prop('disabled') === false)
                department_id = $("#id_department").val();
            if ($("#id_chair").prop('disabled') === false)
                chair_id = $("#id_chair").val();
            if ($("#id_program").prop('disabled') === false)
                program_id = $("#id_program").val();
            if ($("#id_subject").prop('disabled') === false)
                subject_id = $("#id_subject").val();
            if ($("#id_type").val() !== '')
                type_id = $("#id_type").val();
            return {
                "university_id": university_id,
                "department_id": department_id,
                "chair_id": chair_id,
                "program_id": program_id,
                "subject_id": subject_id,
                "type_id": type_id
            };
        }

        function new_search_request(data) {
            $.ajax({
                url: "/get_posts/",
                data: data,
                dataType: 'json',
                success: function (data) {
                    update_post_list(data);
                }
            });
        }

        $("#id_type").change(function () {
            new_search_request(get_current_values());
        });

        $("#id_subject").change(function () {
            new_search_request(get_current_values());
        });

        function search_posts() {
            let search_request = $("#search-line").find("input").val().toLowerCase();
            $.ajax({
                url: "/search_posts/",
                data: {"search_request": search_request},
                dataType: 'json',
                success: function (data) {
                    update_post_list(data);
                }
            });
        }


    </script>

{% endblock %}
